{% extends 'base.html' %}

{% block title %}Mensagem para {{ cliente.nome }}{% endblock %}

{% block content %}
<div class="container mt-5">

    <div class="card shadow p-4 text-center">
        <h2 class="mb-3">Olﾃ｡, {{ cliente.nome }}! 窓</h2>
        <p class="lead">Assine o contrato abaixo.</p>
        <p>ﾃ〉ea do procedimento: {{ cliente.area }}</p>
    </div>

</div>

<!-- ================= FORM POST (ASSINATURA) ================= -->
<div class="card shadow-sm mt-4">
    <div class="card-body">

        <h4 class="mb-3 text-center">Assine abaixo:</h4>

        <form method="post">
            {% csrf_token %}

            <div class="d-flex justify-content-center mb-3">
                <canvas id="pad" width="400" height="200"
                        class="border border-2 rounded w-100"
                        style="max-width: 450px;"></canvas>
            </div>

            <div class="d-flex gap-2 justify-content-center mb-3">
                <button type="button" class="btn btn-secondary" onclick="limpar()">Limpar</button>
                <button type="button" class="btn btn-success" onclick="salvar()">Salvar Assinatura</button>
            </div>

            <input type="hidden" name="imagem" id="imagem">
        </form>

    </div>
</div>

<script>
// ==============================================================
// CONFIGURAﾃﾃグ DO CANVAS COM DESENHO SUAVE E SINCRONIZADO
// ==============================================================

let canvas = document.getElementById("pad");
let ctx = canvas.getContext("2d");

let desenhando = false;
let pontos = [];
let ultimaPos = null;

// ============ CORREﾃﾃグ ABSOLUTA DE ESCALA (TOQUE E MOUSE) ============
function getPos(e) {
    let rect = canvas.getBoundingClientRect();

    // fator de escala entre dimensﾃ｣o real e dimensﾃ｣o CSS
    let escalaX = canvas.width / rect.width;
    let escalaY = canvas.height / rect.height;

    let x, y;

    if (e.touches) {
        let t = e.touches[0];
        x = (t.clientX - rect.left) * escalaX;
        y = (t.clientY - rect.top) * escalaY;
    } else {
        x = (e.clientX - rect.left) * escalaX;
        y = (e.clientY - rect.top) * escalaY;
    }

    return { x, y };
}

// Inﾃｭcio do desenho
function iniciarDesenho(e) {
    desenhando = true;
    pontos = [];
    ultimaPos = getPos(e);
    pontos.push(ultimaPos);
    e.preventDefault();
}

// Termina o desenho
function encerrarDesenho() {
    desenhando = false;
    ultimaPos = null;
    pontos = [];
}

// Movendo o dedo/mouse
function mover(e) {
    if (!desenhando) return;
    let pos = getPos(e);
    pontos.push(pos);
    e.preventDefault();
}

// ================= DESENHO SUAVE COM ANIMAﾃﾃグ =================
function loopDesenho() {
    if (pontos.length > 1) {
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        ctx.strokeStyle = "#000";

        ctx.beginPath();
        ctx.moveTo(pontos[0].x, pontos[0].y);

        for (let i = 1; i < pontos.length; i++) {
            ctx.lineTo(pontos[i].x, pontos[i].y);
        }

        ctx.stroke();

        // Mantﾃｩm apenas o ﾃｺltimo ponto para suavidade
        pontos = [pontos[pontos.length - 1]];
    }

    requestAnimationFrame(loopDesenho);
}
loopDesenho();

// ==================== EVENTOS MOUSE ====================
canvas.addEventListener("mousedown", iniciarDesenho);
canvas.addEventListener("mouseup", encerrarDesenho);
canvas.addEventListener("mousemove", mover);

// ==================== EVENTOS TOUCH ====================
canvas.addEventListener("touchstart", iniciarDesenho, { passive: false });
canvas.addEventListener("touchend", encerrarDesenho);
canvas.addEventListener("touchmove", mover, { passive: false });

// ==================== FUNﾃﾃグ LIMPAR ====================
function limpar() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
}

// ==================== FUNﾃﾃグ SALVAR ====================
function salvar() {
    let dataURL = canvas.toDataURL("image/png");
    document.getElementById("imagem").value = dataURL;
    document.forms[1].submit();
}
</script>

{% endblock %}
